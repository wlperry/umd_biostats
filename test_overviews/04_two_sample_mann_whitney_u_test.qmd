---
title: "Two Sample Mann_Whitney Test"
author: "Bill Perry"
execute:
  freeze: false
  cache: true
  echo: true
format:
  html:
    toc: false
    output-file: "04_mann_whitnely_two_sample_test_html.html"
    embed-resources: true
    css: ../css/activity.css
  docx:
    default: true
    toc: false
    toc-depth: 3
    number-sections: false
    highlight-style: github
    reference-doc: ../ms_templates/custom-reference.docx
    css: ../css/msword.css
    embed-resources: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Introduction to Mann-Whitney-Wilcoxon Test

## Background and Theory

The Mann-Whitney-Wilcoxon test (also known as the Wilcoxon rank-sum test or Mann-Whitney U test) is a powerful non-parametric alternative to the two-sample t-test. This test is particularly useful when:

1.  The data do not follow a normal distribution
2.  The sample sizes are small
3.  Data are measured on an ordinal scale
4.  Outliers are present

Unlike the t-test, which compares means, the Mann-Whitney-Wilcoxon test compares the distributions of two independent groups. Specifically, it tests whether one distribution is stochastically greater than the other.

The null and alternative hypotheses are:

$$H_0: \text{The distributions of both groups are identical}$$ $$H_A: \text{The distributions of the two groups differ in location (median)}$$

## How the Mann-Whitney-Wilcoxon Test Works

The test follows these steps:

1.  Combine all observations from both groups and rank them from lowest to highest.
2.  Calculate the sum of ranks for each group.
3.  Calculate the U statistic, which represents the number of times observations in one group precede observations in the other group.
4.  Compare the calculated U statistic to the critical value from the Mann-Whitney-Wilcoxon distribution, or calculate a p-value for larger samples.

The U statistic is calculated as:

$$U_1 = R_1 - \frac{n_1(n_1 + 1)}{2}$$

Where: - $R_1$ is the sum of ranks in group 1 - $n_1$ is the sample size of group 1

If U is sufficiently small or large compared to what would be expected by chance, we reject the null hypothesis.

# Data Analysis

## Loading Libraries and Data

```{r}
# Load required libraries
library(tidyverse)
library(ggpubr)  # For adding statistical test results to plots
library(coin)    # For exact Mann-Whitney-Wilcoxon test


```

```{r}
# Load the data
sculpin_data <- read_csv("data/sculpin.csv")

# Preview the data
head(sculpin_data)
```

## Data Overview

Let's first examine the structure of our dataset:

```{r}
# Structure of the dataset
str(sculpin_data)

# Summary statistics
summary(sculpin_data)

# Check for missing values
colSums(is.na(sculpin_data))
```

## Data Preparation

For our analysis, we'll filter the data to include only the two lakes we're interested in comparing (S 07 and NE 14) and remove any missing values:

```{r}
# Select lakes for comparison
lakes_to_compare <- c("S 07", "NE 14")

# Filter data
sculpin_filtered <- sculpin_data %>%
  filter(lake %in% lakes_to_compare) %>%
  filter(!is.na(total_length_mm))

# Create individual datasets for each lake
s07_data <- sculpin_filtered %>% filter(lake == "S 07")
ne14_data <- sculpin_filtered %>% filter(lake == "NE 14")

# Check the number of observations per lake and get basic statistics
lake_stats <- sculpin_filtered %>%
  group_by(lake) %>%
  summarize(
    n = n(),
    mean = mean(total_length_mm),
    sd = sd(total_length_mm),
    se = sd / sqrt(n),
    median = median(total_length_mm),
    min = min(total_length_mm),
    max = max(total_length_mm),
    Q1 = quantile(total_length_mm, 0.25),
    Q3 = quantile(total_length_mm, 0.75)
  )

print(lake_stats)
```

# Data Visualization

Let's visualize our data to better understand the distributions and differences between the two lakes:

## Box Plot with Individual Data Points

```{r fig.width=10, fig.height=6}
# Create boxplot with individual points using position_dodge2
ggplot(sculpin_filtered, aes(x = lake, y = total_length_mm, fill = lake)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_point(position = position_dodge2(width = 0.3), 
             alpha = 0.5, size = 2) +
  labs(
    title = "Total Length of Slimy Sculpin Fish by Lake",
    x = "Lake",
    y = "Total Length (mm)",
    fill = "Lake"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.position = "bottom"
  ) +
  scale_fill_brewer(palette = "Set2")
```

The boxplot shows the distribution of total lengths for each lake. The box represents the interquartile range (IQR, from the 25th to 75th percentile), with the horizontal line inside the box indicating the median. The individual points help us visualize the full distribution of the data.

## Density Plots with Median Lines

```{r fig.width=10, fig.height=6}
# Create density plots with median markers
ggplot(sculpin_filtered, aes(x = total_length_mm, fill = lake)) +
  geom_density(alpha = 0.6) +
  geom_vline(data = lake_stats, 
             aes(xintercept = median, color = lake),
             linewidth = 1, linetype = "dashed") +
  labs(
    title = "Density Distribution of Slimy Sculpin Total Length by Lake",
    subtitle = "Dashed lines indicate medians",
    x = "Total Length (mm)",
    y = "Density",
    fill = "Lake",
    color = "Median"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5),
    legend.position = "bottom"
  ) +
  scale_fill_brewer(palette = "Set2") +
  scale_color_brewer(palette = "Set2")
```

The density plots show the continuous distribution of lengths for each lake, with dashed lines marking the median values. This visualization is particularly relevant for the Mann-Whitney-Wilcoxon test, which compares medians rather than means.

# Why Use the Mann-Whitney-Wilcoxon Test?

Before proceeding with the Mann-Whitney-Wilcoxon test, let's examine whether the data meet the assumptions for parametric tests like the t-test:

## Assessing Normality

```{r fig.width=10, fig.height=6}
# Create QQ plots for each lake
par(mfrow = c(1, 2))

# Lake S 07
qqnorm(s07_data$total_length_mm, 
       main = "Q-Q Plot for Lake S 07", 
       col = "blue")
qqline(s07_data$total_length_mm)

# Lake NE 14
qqnorm(ne14_data$total_length_mm, 
       main = "Q-Q Plot for Lake NE 14", 
       col = "green")
qqline(ne14_data$total_length_mm)
```

```{r}
# Shapiro-Wilk test for normality
shapiro_s07 <- shapiro.test(s07_data$total_length_mm)
shapiro_ne14 <- shapiro.test(ne14_data$total_length_mm)

cat("Shapiro-Wilk test for Lake S 07:\n")
print(shapiro_s07)

cat("\nShapiro-Wilk test for Lake NE 14:\n")
print(shapiro_ne14)
```

Based on the Q-Q plots and Shapiro-Wilk tests, we can assess whether our data follow a normal distribution. The Mann-Whitney-Wilcoxon test is appropriate regardless of the outcome because it doesn't assume normality.

## Assumptions of the Mann-Whitney-Wilcoxon Test

The Mann-Whitney-Wilcoxon test has the following assumptions:

1.  **Independent samples**: The observations in each group are independent of each other, and the two groups are independent of each other.

2.  **Ordinal data**: The measurements must be at least on an ordinal scale (can be ranked).

3.  **Similar distributions**: If testing for differences in medians specifically, the shapes of the distributions should be similar (though not necessarily normal).

Let's check if our data meet these assumptions:

```{r}
# Compare distribution shapes visually
ggplot(sculpin_filtered, aes(x = total_length_mm, fill = lake)) +
  geom_density(alpha = 0.5) +
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = "Comparing Distribution Shapes Between Lakes",
    x = "Total Length (mm)",
    y = "Density"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```

If the distributions have roughly similar shapes (even if they're shifted), we can interpret the Mann-Whitney-Wilcoxon test as testing for differences in medians. If the shapes differ substantially, the test more broadly examines whether one distribution is stochastically greater than the other.

# Performing the Mann-Whitney-Wilcoxon Test

Now let's perform the Mann-Whitney-Wilcoxon test to compare the total lengths between the two lakes:

## Using Base R's wilcox.test Function

```{r}
# Perform the Mann-Whitney-Wilcoxon test
wilcox_test <- wilcox.test(total_length_mm ~ lake, 
                          data = sculpin_filtered,
                          exact = FALSE,  # Use approximate method for larger samples
                          correct = TRUE)  # Apply continuity correction

# Display the results
print(wilcox_test)

# Store the p-value for later use
p_value <- wilcox_test$p.value
```

## Using the coin Package for an Exact Test

For more precise results, especially with smaller samples, we can use the `coin` package to perform an exact Mann-Whitney-Wilcoxon test:

```{r}
# Convert lake to factor (required for the coin package)
sculpin_filtered$lake_factor <- factor(sculpin_filtered$lake)

# Perform the Mann-Whitney test using the approximate method
# (which works reliably for all sample sizes)
coin_wilcox <- coin::wilcox_test(
  total_length_mm ~ lake_factor,
  data = sculpin_filtered,
  distribution = "approximate"
)

# Display the results
print(coin_wilcox)

# Extract the p-value
pvalue_coin <- pvalue(coin_wilcox)
cat("p-value:", pvalue_coin, "\n")
```

## Calculating Effect Size

The Mann-Whitney-Wilcoxon test tells us whether there's a statistically significant difference, but it doesn't indicate the magnitude of that difference. Let's calculate an effect size measure:

```{r}
## Calculating Effect Size

# The Mann-Whitney-Wilcoxon test tells us whether there's a statistically significant difference, but it doesn't indicate the magnitude of that difference. Let's calculate an effect size measure:

# Calculate standardized effect size using rank-biserial correlation
# (equivalent to r = Z / sqrt(N))
z_score <- qnorm(p_value/2)  # Convert p-value to Z-score
N <- nrow(sculpin_filtered)
r <- abs(z_score) / sqrt(N)  # Rank-biserial correlation

cat("Effect size (rank-biserial correlation):", round(r, 3), "\n")

# Interpret effect size
effect_size <- r
if(effect_size < 0.1) {
  effect_interpretation <- "negligible"
} else if(effect_size < 0.3) {
  effect_interpretation <- "small"
} else if(effect_size < 0.5) {
  effect_interpretation <- "moderate"
} else if(effect_size < 0.7) {
  effect_interpretation <- "large"
} else {
  effect_interpretation <- "very large"
}

cat("This represents a", effect_interpretation, "effect.\n")
```

# Median and Interquartile Range (IQR) Plot with Test Results

Since the Mann-Whitney-Wilcoxon test is primarily concerned with medians rather than means, let's create a plot showing the median and IQR for each lake:

```{r fig.width=10, fig.height=6}
# Format p-value text
p_value_text <- ifelse(p_value < 0.001, 
                      "p < 0.001", 
                      paste("p =", round(p_value, 3)))

# Create median and IQR plot with data points
ggplot() +
  # Add individual data points in the background
  geom_point(data = sculpin_filtered, 
             aes(x = lake, y = total_length_mm, color = lake),
             position = position_dodge2(width = 0.3), 
             alpha = 0.5, size = 1.5) +
  # Add boxplot without outliers
  geom_boxplot(data = sculpin_filtered,
               aes(x = lake, y = total_length_mm, fill = lake),
               alpha = 0.7, outlier.shape = NA, width = 0.5) +
  # Add annotations for the medians
  geom_text(data = lake_stats,
            aes(x = lake, y = median + 7, 
                label = paste0("Median: ", round(median, 1), " mm")),
            size = 3.5) +
  # Add Mann-Whitney test result
  annotate("text", x = 1.5, y = max(sculpin_filtered$total_length_mm) + 5,
           label = paste0("Mann-Whitney-Wilcoxon test: ", p_value_text,
                          " (r = ", round(r, 2), ")"),
           size = 3.5) +
  labs(
    title = "Median Total Length (with IQR) of Slimy Sculpin Fish by Lake",
    x = "Lake",
    y = "Total Length (mm)",
    fill = "Lake",
    color = "Lake",
    caption = paste0("n(S 07) = ", nrow(s07_data), ", n(NE 14) = ", nrow(ne14_data))
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.position = "bottom"
  ) +
  scale_fill_brewer(palette = "Set2") +
  scale_color_brewer(palette = "Set2")
```

# Interpreting the Mann-Whitney-Wilcoxon Test Results

```{r}
# Calculate median difference and percent difference
median_diff <- abs(diff(lake_stats$median))
percent_diff <- median_diff / min(lake_stats$median) * 100

cat("Absolute median difference:", round(median_diff, 2), "mm\n")
cat("Percent difference in medians:", round(percent_diff, 1), "%\n")
```

## Understanding the Mann-Whitney-Wilcoxon Test Results

The Mann-Whitney-Wilcoxon test provides a p-value that represents the probability of observing the rank sum (or a more extreme value) if the null hypothesis were true (i.e., if there were no difference in the distributions of the two lakes).

Our analysis shows:

1.  **Observed Difference**: The observed difference in median total length between Lake S 07 and Lake NE 14 is `r round(median_diff, 2)` mm.

2.  **p-value**: The Mann-Whitney-Wilcoxon test yielded a p-value of `r ifelse(p_value < 0.001, "< 0.001", round(p_value, 3))`.

3.  **Effect Size**: The rank-biserial correlation (r = `r round(r, 2)`) indicates a `r effect_interpretation` effect size.

4.  **Interpretation**: Since the p-value is `r ifelse(p_value < 0.05, "less than 0.05", "greater than 0.05")`, we `r ifelse(p_value < 0.05, "reject", "fail to reject")` the null hypothesis. This indicates that the distributions of fish lengths between the two lakes are `r ifelse(p_value < 0.05, "significantly different", "not significantly different")`.

## Advantages of the Mann-Whitney-Wilcoxon Test

The Mann-Whitney-Wilcoxon test offered several advantages for this analysis:

1.  **No Normality Assumption**: It doesn't require the data to follow a normal distribution, making it appropriate for many ecological datasets.

2.  **Robust to Outliers**: By using ranks instead of actual values, it's less sensitive to extreme observations.

3.  **Applicable to Ordinal Data**: It can be used even when data are measured on an ordinal rather than interval scale.

4.  **Efficiency**: With normally distributed data, the test has 95% efficiency compared to the t-test, but can be more powerful when distributions are non-normal.

5.  **Interpretability**: It provides a clear assessment of whether one population tends to have larger values than the other.

## Comparison to Parametric Tests

For comparison, let's see what a standard t-test would have concluded:

```{r}
# Perform a t-test for comparison
t_test_result <- t.test(total_length_mm ~ lake, data = sculpin_filtered)
print(t_test_result)

# Compare p-values
cat("Mann-Whitney-Wilcoxon p-value:", p_value, "\n")
cat("t-test p-value:", t_test_result$p.value, "\n")
```

In this case, both tests lead to `r ifelse(p_value < 0.05 & t_test_result$p.value < 0.05, "the same", "different")` conclusions regarding statistical significance. However, the Mann-Whitney-Wilcoxon test is more appropriate when normality assumptions are violated, and it's testing a different hypothesis (difference in distributions rather than means).

# How to Report These Results in a Scientific Publication

When reporting these results in a scientific publication, follow this format:

"Slimy sculpin (*Cottus cognatus*) from Lake S 07 had significantly greater total lengths than those from Lake NE 14 (median: `r round(lake_stats$median[lake_stats$lake == "S 07"], 1)` mm vs. `r round(lake_stats$median[lake_stats$lake == "NE 14"], 1)` mm, respectively; Mann-Whitney-Wilcoxon test, W = `r wilcox_test$statistic`, p `r ifelse(p_value < 0.001, "< 0.001", paste("=", round(p_value, 3)))`, r = `r round(r, 2)`)."

For the methods section:

"Due to violations of normality assumptions, differences in sculpin length between lakes were assessed using the non-parametric Mann-Whitney-Wilcoxon test. Effect size was calculated using the rank-biserial correlation coefficient (r)."

For figures, include a caption such as:

"Figure X. Total length of slimy sculpin fish from two Arctic lakes, showing median and interquartile range. Fish from Lake S 07 (n = 73) had significantly greater lengths than those from Lake NE 14 (n = 37) (Mann-Whitney-Wilcoxon test, p \< 0.001, r = `r round(r, 2)`)."

# Conclusion

The Mann-Whitney-Wilcoxon test revealed a significant difference in the total length distributions of slimy sculpin fish between Lake S 07 and Lake NE 14, with fish from Lake S 07 having greater lengths. The `r effect_interpretation` effect size (r = `r round(r, 2)`) indicates that this difference is not only statistically significant but also biologically meaningful.

This non-parametric approach was appropriate given the potential violations of normality assumptions, and it provided robust evidence of differences between the two lake populations. The approximately `r round(percent_diff, 1)`% difference in median lengths suggests substantial ecological differences between these habitats that warrant further investigation.
